<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 5.4.4 (402282)"/><meta name="author" content="jennyzj"/><meta name="created" content="2014-05-26 08:00:10 +0000"/><meta name="updated" content="2014-05-26 08:00:21 +0000"/><title>mtop的h5访问方式</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="-evernote-last-insertion-point:true;"/>   mtop对于h5的访问采用了和客户端不同的方式，由于在h5的js代码中保存appsercret具有较高的风险，mtop采用了随机分配令牌的方式，为每个访问端分配一个token，保存在用户的cookie中，通过cookie带回服务端分配的token, 客户端利用分配的token对请求的URL参数生成摘要值sign,</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">MTOP利用这个摘用值和cookie中的token来防止URL篡改。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">      H5与mtop的交互如下图：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">     <img src="mtop%E7%9A%84h5%E8%AE%BF%E9%97%AE%E6%96%B9%E5%BC%8F.resources/b45ef292ac29b903419d12e6cf89e429.jpeg" height="446" width="307"/></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">        1. 当本地cookie中的token为空时，ajax访问mtop会收到”<span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">FAIL_SYS_TOKEN_EXOIRED:: 令牌过期“这个错误应答，同时mtop会生成token写入cookie中。</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        2.第二次请求时，js通过读取cookie中的token值，按照约定的算法生成sign, sign在mtop的请求中带上，mtop通过cookie中和token用同样的方式计算出sign,与请求的sign进行比较，检查通过将返回api的应答，失败提示“</span><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">FAIL_SYS_ILLEGAL_ACCESS:: 非法请求</span><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">”</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        3.cookie中的token是有时效性的，遇到token失效时，将收到应答"</span><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">FAIL_SYS_TOKEN_EXOIRED:: 令牌过期</span><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">", 同时会写入新的token,js利用新的token重新计算sign并重发请求。</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"/>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        关于cookie中的token的自我检查，由于token在cookie中是明文的，可能会被仿冒，在输出的cookie中包含一个用非对称密钥的公钥加密后的token, MTOP在每次请求时会先检查cookie中的token是否是由服务端分配出去的（利用加密后的token和私钥还原token，与回传的明文token比较）</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        </span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        关于跨域调用问题，mtop支持两种形式jsonp和cors,</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        jsonp, 目前cookie支持种在m.taobao.com(通过api.m.taobao.com域请求),cookie种在m.etao.com(通过apie.m.etao.com请求,api.m.etao.com被人用掉了-_-!!), cookie种在m.tmall.com(通过api.m.tmall.com请求)</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: inherit; line-height: 20px;">        cors, <a href="http://%E6%94%AF%E6%8C%81%E6%89%80%E6%9C%89.taobao.com">支持所有.taobao.com</a>, .<a href="http://etao.com">etao.com</a>, .tmall.com的域的请求。(CORS参见：</span><a href="http://www.w3.org/TR/cors/#resource-processing-model" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; font-family: inherit; line-height: 20px; background-position: initial initial; background-repeat: initial initial;">http://www.w3.org/TR/cors/#resource-processing-model</a>，<a href="https://developer.mozilla.org/zh-CN/docs/HTTP/Access_control_CORS" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; font-family: inherit; line-height: 20px; background-position: initial initial; background-repeat: initial initial;">https://developer.mozilla.org/zh-CN/docs/HTTP/Access_control_CORS</a>）</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">       </p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; line-height: 20px;">         关于cookie的有效时长，cookie的有效时长为7天，但是token的有效时长目前为60分钟</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; line-height: 20px;">         </span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; line-height: 20px;">         关于token的格式</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; line-height: 20px;">          </span><span style="box-sizing: border-box; line-height: 20px;">_m_h5_tk: 格式为 明文token_expireTime,  如：              2fcd2baa62fc60f73c0487a9f8a0a9d1_1362559577301</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;">_m_h5_tk_enc：整个_m_h5_tk的加密，如：96aee6606958350511ef980535e23cf4</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;"> </p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;">          关于sign的生成公式：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;">         <span style="box-sizing: border-box; font-family: inherit;">md5Hex(token&amp;t&amp;appKey&amp;data)</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;"><span style="box-sizing: border-box; font-family: inherit;">         如：</span><span style="box-sizing: border-box; font-family: 'courier new', courier, monospace;">md5Hex(“645d1f414d4914297dfaab40f3f76016 &amp;1234&amp;4272&amp;{</span><span style="box-sizing: border-box; font-family: inherit; color: rgb(0, 145, 0); background-color: inherit;">"itemNumId"</span><span style="box-sizing: border-box; font-family: 'courier new', courier, monospace;">:</span><span style="box-sizing: border-box; font-family: inherit; color: rgb(0, 145, 0); background-color: inherit;">"1500011132496"</span><span style="box-sizing: border-box; font-family: 'courier new', courier, monospace;">}”)</span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;"><span style="box-sizing: border-box; font-family: 'courier new', courier, monospace;">        sign=</span><span style="box-sizing: border-box; font-family: inherit;">d2b2f818a03496b296b899a230c03abd </span></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: inherit; font-size: 16px; background-color: rgb(255, 255, 255); line-height: 20px; background-image: none;"><span style="box-sizing: border-box; font-family: inherit;">         获取H5 SDK(只支持jsonp方式),咨询：武仲、苍至</span></p>
<div><br/></div>
</body></html>