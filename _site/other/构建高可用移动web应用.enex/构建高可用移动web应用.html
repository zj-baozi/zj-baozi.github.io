<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 5.4.4 (402282)"/><meta name="author" content="jennyzj"/><meta name="created" content="2014-05-26 07:27:51 +0000"/><meta name="updated" content="2014-05-26 07:31:21 +0000"/><title>构建高可用移动web应用</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://img4.tbcdn.cn/L1/461/1/5ffe3fc32a2a56fde5f58a3ffca00cee3709ba56" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/c4406c374fa8373f95063d5694b7cf71.png" height="374" width="773"/></a></p>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">选择的智慧</h2>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">移动浪潮下，移动端应用的开发炙手可热。对于技术人员，有时我们还面对着如何选择技术栈的问题，选择Native还是Web？虽然笔者是Web技术拥护者，但负责任的答案是在当前（只是当前）Native优先，Web退而求之。那为什么我们还需要关注移动Web技术，为什么我们还需要投入那么多人力在移动Web技术上呢？总结Web技术的优势，我想会对你的选择有帮助。</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">业务能力优势</h3>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">通常无需跟随客户端版本</li>
<li style="box-sizing: border-box;">能更好的支撑运营</li>
<li style="box-sizing: border-box;">需求变更的好伙伴</li>
<li style="box-sizing: border-box;">无可比拟的扩展机制，连接一切</li>
</ol>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">开发效率优势</h3>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">HTML5</li>
<li style="box-sizing: border-box;">跨平台，跨终端</li>
<li style="box-sizing: border-box;">移动终端的更新换代频率，逐渐淘汰移动端“IE6s”</li>
</ol>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">技术发展优势</h3>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">HTTP2.0 与 SPDY</li>
<li style="box-sizing: border-box;">Web Components</li>
<li style="box-sizing: border-box;">Web标准化进程</li>
</ol>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">Web的优势是Native难以企及的，可以肯定的是Native的优势随着硬件与浏览器技术的发展会渐渐被弱化。即使在当前移动Web技术主要实践在周边扩展业务，但在业务量级上，无论是手机淘宝还是笔者曾经负责过的手机QQ，Web与Native的投入都是相当的，由此也可见移动Web在当前无可争议的重要程度。</p>
<span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">三足鼎立于移动互联网，选择贤材，各任之以其能。Web是那战场上的骑兵，敏捷机动、骁勇好战；而Native是步兵，坚固稳定。</span><span style="font-size: 11px; font-family: Helvetica; letter-spacing: 0px;"><br/></span>
<div><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;"><br/></span></div>
<h1 style="box-sizing: border-box; font-size: 18px; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(78, 78, 78); word-wrap: break-word; overflow: hidden; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 32px;">《构建高可用移动Web应用 》兼容篇</span></h1>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">看挑战</h2>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">同时，当前移动Web技术背后依旧蕴含着不少挑战（挑战无处不在，Native技术栈亦然）。有来自碎片化问题的挑战，主要体现在移动操作系统平台多样版本多样、不同设备屏幕尺寸多样。有来自弱网络环境的挑战，主要体现在网络延迟高，丢包率高，带宽低。有来自设备低性能的挑战，主要体现在动画卡顿，运行不流畅。在此篇章中我们将讨论当前移动Web开发中版本兼容策略。</p>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">移动操作系统</h2>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">关注市面上已有各种不同的操作系统的设备：iOS、Android、Window Phone、BlackBerry 、Firefox OS、Tizen、Ubuntu Touch等，与主流的iOS与Android相比，其他的移动操作系统市场份额太低通常不会进行功能的同步开发迭代。iOS与Android的版本兼容又是什么策略？我们看下各系统版本的占比数据：</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">Android系统版本</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2748927/842a51b2-c7e1-11e3-9699-d6d048cded08.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/0c47c49bc1367de05b1c49082e294658.png" height="762" width="1267"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">图片来源：<a href="http://en.wikipedia.org/wiki/Android_version_history" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">http://en.wikipedia.org/wiki/Android_version_history</a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">Android 4.0- 的用户主要是 2.3 依旧是还有近 20%的用户，但从趋势中我们可以预测，只需在1-2年的时候4.0-的用户将会低于5%。不过在当前我们依旧还需要照顾这些低端设备：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://img2.tbcdn.cn/L1/461/1/7c45a3dc42e05a2f0e04972158a5cd22cb1401e0" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/f483319922a6b5c5b9e87ffceca04a7c.png" height="488" width="1096"/></a></p>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">屏幕尺寸</h2>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2750300/4fdab146-c867-11e3-8e08-0a3e0eab1c9a.jpg" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/a9017ce8db10508b27db5621f8fd7d07.jpeg" height="533" width="800"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">图片来源：<a href="http://www.flickr.com/photos/lukew/sets/72157636814608894/with/10460259253/" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">http://www.flickr.com/photos/lukew/sets/72157636814608894/with/10460259253/</a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">移动设备分辨率多样，初次接触通常会无所适从。在浏览器中，Web前端开发者实际面对的是CSS像素，所以我们对主流设备的物理分辨率转换为CSS像素时(物理分辨率/设备像素比devicePixelRatio)，你会发现这其中的可循规律：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2875248/423a0aa2-d413-11e3-8928-5dbde3c744ad.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/b2dee931b59d71b7bd5d04cf77fd343a.png" height="796" width="1314"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">再对各个CSS像素占比进行统计：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2875251/49a93b96-d413-11e3-943c-e69501a1ea8e.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/084cf9b3182edd4e81bf8a32bcafe2f4.png" height="726" width="1182"/></a></p>
<div><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">如图可知</span><code style="letter-spacing: 0.03rem; line-height: 27.200000762939453px; box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">320px</code><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">几乎覆盖了绝大部分的设备（所有的苹果手机都是</span><code style="letter-spacing: 0.03rem; line-height: 27.200000762939453px; box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">320px</code><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">），其次是</span><code style="letter-spacing: 0.03rem; line-height: 27.200000762939453px; box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">360px</code><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">。所以，即使设备物理像素的尺寸千差万别，我们在移动Web设计开发过程中，只需重点考虑</span><code style="letter-spacing: 0.03rem; line-height: 27.200000762939453px; box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">320px</code><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">与</span><code style="letter-spacing: 0.03rem; line-height: 27.200000762939453px; box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">360px</code><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;">宽度，其他宽度的占比太小可以结合具体业务的场景来决定是否完美兼容。</span><span style="box-sizing: border-box; font-size: 32px;"><br/></span></div>
<div><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;"><br/></span></div>
<h1 style="box-sizing: border-box; font-size: 18px; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(78, 78, 78); word-wrap: break-word; overflow: hidden; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 32px;">《构建高可用移动Web应用 》网络篇</span></h1>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">移动网络</h2>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">我们常把移动网络描述为弱网络环境，主要原因在于移动设备接入方式的多样，经统计目前至今约还有20%的用户依旧是使用2G网络（包含2.5G），并且2G/3G网络的物理层延迟都较高：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2875035/39b938ea-d408-11e3-8ef0-948914efef7f.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/86ddb7a700bb66257ecbefe31de3930a.png" height="604" width="1206"/></a></p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">请求模型</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">我们通过下图剖析移动网络下的请求过程：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2874986/7131e0f4-d405-11e3-841f-c238eb739ddf.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/15c6a894edcd350a62e4c313f7225aab.png" height="608" width="1318"/></a></p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">关于延迟</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">什么是延迟？我们把网络比喻为高速公路，网络传输比特包packet，而高速公路传输汽车，延迟是高速公路的长度，带宽如其名中的“宽”字，是高速公路的宽度。为了理解为什么延迟是无线网络下静态资源加载的性能瓶颈，我们从例子来讲解。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">我们在西藏访问在杭州机房的接入服务器，从西藏到杭州距离约4100km，<br style="box-sizing: border-box;"/>
<br/>
假设通过光纤连接两端进行传输，按光速需耗时约 4100km / 300km/ms = 13.7ms，<br style="box-sizing: border-box;"/>
<br/>
光纤耗时通常约为光速的1.5倍，则光纤传输耗时约 13.7ms * 1.5 ～＝21ms，<br style="box-sizing: border-box;"/>
<br/>
得到RTT为21ms * 2 ＝ 42ms（暂不考虑因Trace Route而产生的延迟，通过查询相关数据此延迟通常为18-44ms，即实际第一次的RTT在60-86ms区间）。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">当用户通过手机第一次访问<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;"><a href="http://taobao.com">taobao.com</a></code>时，手机首先会与移动运营商网络建立信道，运营商网络从逻辑层面可以分为 无线电接入网络（RAN：Radio Access Network）与 核心网络（CN：Core Network）。</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">无线电资源控制器 Radio Resource Controler</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">RCC是由定时器驱动的状态机，3/4G网络下连接状态通常还包含2类子状态：激活态、休眠态（LTE分短、长）。而状态的转换时机是由运营商配置的超时时间决定的。</p>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">RCC的设计目的？</h4>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">RCC状态机的设计主要考虑两点原因？</p>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">无线电连接是高耗电操作，通过RCC状态转化机制优化设备耗电</li>
<li style="box-sizing: border-box;">无线电是有限的资源，合理分配资源</li>
</ol>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">进一步了解RCC与手机间的工作模式。我们把无线电资源控制器（RCC：Radio Resource Controler）好比是整个无线接入网络的门神，管理着各个无线设备的接入许可，哪个设备什么时候接入网络，接入带宽是多少，信号强度是多少等等。如早晨睡醒时，你拿起枕边上的手机打开手机淘宝时，手机会第一时间先通知RCC说我要访问网络，然后RCC查看当前的资源占用情况，然后把可分配无线资源分配给你的手机。 当手机有一段时间（已知中国移动是5分钟或10分钟，不同地区存在配置差异）没有进行网络数据交换时，此时RCC将通知手机可以转为空闲（低能耗）状态，而当你有旺旺消息进入时，RCC会先通知手机有数据需要接收，然后手机从空闲状态转入连接（高能耗）状态。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">然而在当前国内主流的2/3G网络下RCC存在于核心网络中的服务网关下（SGW：Serving Gateway）。在LTE 4G网络里，RCC直接挂载于基站，这是LTE延迟也会更低的主要原因之一。</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">浏览器网络</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">建立信道后，然后浏览器会对<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;"><a href="http://taobao.com">taobao.com</a></code>进行域名的DNS解析，得到解析后的IP地址后才能与目标IP的服务器建立HTTP连接。而浏览器初始的工作，无论DNS解析还是建立HTTP连接都是基于TCP协议。因此TCP的工作机制是我们进行优化的理论基础，在TCP/IP协议栈中两个关键特性是三次握手与慢启动机制：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2875048/b8b24326-d408-11e3-8cf6-37ebd6044bad.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/3fea3fe7890d282176c5191c8f11a665.png" height="630" width="1260"/></a></p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">三次握手 Tree-way Handshake</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">什么是三次握手？三次握手是客户端与服务器进行通信前的协商过程，所有初始TCP连接都需经历三次握手的过程才可建立连接，这与TCP用以建立可靠的连接紧密相关.</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">浏览器需至少经过一次RTT时间才可以正式发送数据给服务器，即我们在敲下回车后，浏览器至少需等待1个RTT的时间才告诉服务器说我要访问淘宝首页taobao.com，而这个1个RTT时间在初始访问过程中是无法避免的，在Linux TCP/IP协议栈中，服务端收到三次握手中的最后一个ACK才会创建Socket，同时把Socket状态设置为TCP_SYN_RECV，并且设置初始滑动窗口大小initcwnd，用以TCP慢启动过程。</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">慢启动 SLow Start</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">什么是慢启动？一言以蔽之，用以动态增加“汽车”裝载量的过程。慢启动机制对于大文件类请求如文件下载并不是一个需要特别在意的问题，因为通常只需几百毫秒即可达到最大装载能力，只是整个下载过程中极少的一部分时间消耗。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">而对于HTTP请求多是短猝性（连接短+数据少）的特点，整个请求过程可能都不到一秒，此时这几百毫秒的加速过程则成为了整个网络请求的性能瓶颈之一。所以初始的装载量对于HTTP请求则显得至关重要，而初始滑动窗口大小initcwnd即决定了最初的装载量。</p>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">基于TCP的优化</h2>
<ul style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">无法让延迟时间变小，但可以让延迟数量变少；</li>
<li style="box-sizing: border-box;">无法改变三次握手机制，但可以复用连接避免三次握手；</li>
<li style="box-sizing: border-box;">无法改变慢启动机制，但可以控制首屏资源包在14KB内来减弱慢启动的影响；</li>
</ul>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">保持活跃连接 HTTP Keep Alive</h3>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">保持活跃连接使Socket连接被重用，从而避免每次的请求都需经三次握手协商。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">KeepAlive是对复用连接的一种模式，并有超时机制。当浏览器与服务器间建立保持活跃连接时，浏览器会重用用于接收该初始请求的同一个Socket，直到该Socket的空闲时间超过设置的过期时间。一旦该连接空闲超过过期时间，浏览器则会将回收该连接，然后在之后的请求中将重新初始一个新的Socket，而初始过程则需重新经过三次握手过程。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">在HTTP 1.1协议中，默认是建立KeepAlive连接。如果浏览器支持Keep Alive，它会在请求的包头中添加<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">Connection:keep-alive</code>。当Web服务器收到请求并作出回应的时，也需添加一个<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">Connection:keep-alive</code>头在响应中。如此即可建立了一个保持活跃连接（通常现代浏览器对单个域名可最多同时并发6个请求，IE6/7默认最多为2个请求，即使在保持活跃连接过期时间内同时需关注单域名连接数的限制）。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">保持活跃连接是基于两端的协议，只要单端过期则过期。我们首先来关注客户端，不同的浏览器端存在不一样的默认过期时间：</p>
<ul style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">Chrome 默认过期时间为300秒 (每间隔45秒会向服务端发出一个ACK包来保持连接)</li>
<li style="box-sizing: border-box;">IE 6/7/8/9 默认过期时间为60秒 (可通过在注册表中查看与修改，参考<a href="http://support.microsoft.com/kb/813827/zh-cn" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">http://support.microsoft.com/kb/813827/zh-cn</a>)</li>
<li style="box-sizing: border-box;">Firefox 默认过期时间为115秒 (可通过在about:config界面搜索network.http.keep-alive.timeout查看与修改)</li>
<li style="box-sizing: border-box;">Opera 默认为120秒</li>
</ul>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">然同样不同的Web服务器默认过期时间各不相同，并且其默认过期时间往往非常之短。Apache 2.0默认连接过期时间是仅仅是15秒 ，对于Apache 2.2只有5秒，所以需手动配置Web服务器的KeepAliveTimeout时间，结合主流浏览器的默认过期时间，服务器端过期时间推荐可设置为120秒内。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">即使开启了Keep Alive，但受限于Keep Alive的过期时间，据Google在Chrome上的统计依旧有35%的请求依旧需重新建立连接（参考 <a href="http://tools.ietf.org/html/draft-ietf-tcpm-fastopen-02%EF%BC%89%E3%80%82%E5%9B%A0%E5%8F%97%E9%99%90%E4%BA%8E%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AEHTTP" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">http://tools.ietf.org/html/draft-ietf-tcpm-fastopen-02）。因受限于应用层协议HTTP</a> 保持活跃连接（Keep Alive）过期问题，因此Google在网络层提出了TCP快速打开（Fast Open）机制，一种保持会话的类Cookie技术，使之可在之后的会话发起中避免重新经历三次握手建立连接，但目前TCP快速打开机制只在Chrome的浏览器支持，且默认是关闭的。</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">首屏静态资源包传输控制在14KB内</h3>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">为什么是14KB？</h4>
<pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; line-height: 1.42857143; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">
<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; white-space: pre-wrap; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px;">初始拥塞窗口数  initcwnd     ＝10   
最大传输单元 MTU             ＝1500 Bytes
首次传输大小 10 * 1500       ~ 14.5 Kb
返回头 Response Header      ~ 0.5 Kb
内容 Body                   ~ 14 Kb
</code>
</pre>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">极致优化静态资源</h4>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2874908/e19b5daa-d402-11e3-872c-d5b0e4aea819.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/72b07887319578503c7f0e3fc77bb31f.png" height="662" width="1284"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">静态资源优化 CAPA [‘ka:pa:] 法则是对各种优化静态资源方式的归纳与总结：</p>
<ul style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">Compress压缩： 图片优化、HTML优化、JS压缩、CSS优化、开启Gzip</li>
<li style="box-sizing: border-box;">Async异步： 非首屏样式延迟加载，非首屏逻辑脚本延迟加载</li>
<li style="box-sizing: border-box;">Parallel并行： 资源非阻塞式加载，合理分资源包最大化并行加载</li>
<li style="box-sizing: border-box;">Advance预先：预连接、预加载、预渲染、离线机制、内嵌资源、本地存储</li>
</ul>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">通过使用CAPA法则优化静态资源可引导优化的各个方向，帮助建立前端优化的知识体系，让优化有路可寻。</p>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">优化效果</h4>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">优化后的数据在哪？如图当我们把线上原先资源包在～16.5KB优化到～14KB后效果（异步化了一张内嵌图片），responseEnd平均时间从2s降低到1.4s，responseEnd是页面结构完全可用的时间，只需很小的优化该性能指标提升了30%：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2874916/1bc18acc-d403-11e3-850e-bac42a71ab20.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/997e44b37f25fb12180f8159b467a39b.png" height="922" width="1352"/></a></p>
<div><span style="box-sizing: border-box; font-size: 32px;">4、</span></div>
<h1 style="box-sizing: border-box; font-size: 18px; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(78, 78, 78); word-wrap: break-word; overflow: hidden; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 32px;">《构建高可用移动Web应用 》离线篇</span></h1>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">离线缓存</h2>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">如果所有的静态资源已经预先缓存在本地，无需请求线上资源，可想而知没有比直接访问本地更快速的方式了。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">HTML5中提出了应用缓存AppCache规范，但AppCache可以说是为稳定与高速网络环境设计的缓存方案。AppCache中典型的一个特征是要求每次缓存更新过程都是一个完备的过程，任意一个列表中的资源请求失败则整体识别。AppCache没有提供对网络场景的判断，如2/3G网络下不更新，WiFi下才更新的判断机制。并且一旦页面跳转或关闭，即使是正在进行的离线资源的请求也将被重置，导致数据流量的浪费。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">AppCache的技术方向是对的，但在复杂的移动网络下，使用AppCache带来风险的显然太大。在基于Webview的页面，可实践更加稳定可控的离线缓存方案，列出一些关键的特性：</p>
<ul style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">基于本地缓存命中，而不是基于列表</li>
<li style="box-sizing: border-box;">支持预先打包在客户端内，第一次访问即从离线缓存中读取</li>
<li style="box-sizing: border-box;">支持增量更新，服务器端计算前后版本间的差异，节省带宽</li>
<li style="box-sizing: border-box;">独立进程更新，页面即使跳转或关闭也可在后台保持更新</li>
<li style="box-sizing: border-box;">可主动失效，当缓存的版本存在安全问题时，服务器端可推送消息失效当前缓存版本，强制访问线上最新版本</li>
</ul>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">无论是iOS还是Android，实现的思路都是<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">请求代理</code>。 在iOS下可基于<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">NSURLCache</code>实现（实现细节可参考 <a href="http://www.cocoawithlove.com/2010/09/substituting-local-data-for-remote.html" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">http://www.cocoawithlove.com/2010/09/substituting-local-data-for-remote.html</a>），Android下通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">WebViewClient.shouldInterceptRequest</code>（<a href="http://developer.android.com/reference/android/webkit/WebViewClient.html" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">http://developer.android.com/reference/android/webkit/WebViewClient.html</a>）实现。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2750294/e70caa02-c866-11e3-87b9-9965049b4eb9.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/3e9c836c212c923fabe7c68ceeadeff2.png" height="783" width="1118"/></a></p>
<h2 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 30px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">运行性能</h2>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">滚屏卡顿（主要存在于Android设备，尤其在使用iScroll组件时情况会异常严重）</li>
<li style="box-sizing: border-box;">动画延迟与卡顿（GPU初始化引起的延迟）</li>
</ol>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">什么是卡顿？从数据角度即动画FPS &lt; 30，一旦 FPS&lt; 30 肉眼则会感知卡顿。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">以上的问题是页面渲染性能低导致，在桌面端上可以流畅运行的动画效果因手机端软硬件的限制时常发现延迟与卡顿现象。在提出的优化方案之前，我们先深入浏览器的渲染机制（从代码到屏幕的过程），现代浏览器都支持两种渲染模式：软件模式与硬件加速模式。</p>
<h3 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 24px; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(221, 221, 221); background-color: rgb(255, 255, 255);">从代码到屏幕过程</h3>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">软件模式</h4>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">按HTML构建DOM树</li>
<li style="box-sizing: border-box;">按DOM树可见节点构建渲染对象树</li>
<li style="box-sizing: border-box;">按渲染对象树构建渲染图层树</li>
<li style="box-sizing: border-box;">从渲染图层树根节点依次遍历渲染图层，调用各图层的RenderLayer::paintLayer()方法，paintLayer()主要执行以下步骤：
<ol style="box-sizing: border-box;">
<li style="box-sizing: border-box;">预先计算当前图层是否存在相交</li>
<li style="box-sizing: border-box;">递归调用在当前图层之下图层的paintLayer()</li>
<li style="box-sizing: border-box;">访问与当前渲染图层唯一关联的渲染对象（RenderObject）并进行绘制，绘制结果位图（bitmap）装入GraphicsContext中</li>
<li style="box-sizing: border-box;">从渲染对象（RenderObject）开始向下递归渲染对象树（RenderObject tree）直到递归结束或遇到渲染对象存在相关联的渲染图层（RenderLayer）</li>
<li style="box-sizing: border-box;">递归调用在当前图层之上图层的paintLayer()</li>
</ol>
</li>
<li style="box-sizing: border-box;">把各渲染图层位图绘制结果存入内存共享区</li>
<li style="box-sizing: border-box;">Webkit通知浏览器窗口把从在内存共享区中的位图呈现（drawing）在屏幕上</li>
</ol>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">硬件加速模式</h4>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">按HTML构建DOM树，按CSS生成CSSOM混合DOM</li>
<li style="box-sizing: border-box;">按DOM树可见节点构建渲染对象树</li>
<li style="box-sizing: border-box;">按渲染对象树构建渲染层树</li>
<li style="box-sizing: border-box;">按渲染图层树构建GraphicsLayer树</li>
<li style="box-sizing: border-box;">通过合成器（Compositor）递归绘制GraphicsLayer树：
<ol style="box-sizing: border-box;">
<li style="box-sizing: border-box;">计算图层位图（bitmap）</li>
<li style="box-sizing: border-box;">图层位图栅格化为纹理（texture）</li>
<li style="box-sizing: border-box;">上传纹理（texture）至GPU</li>
<li style="box-sizing: border-box;">GPU合并各图层纹理（texture）</li>
<li style="box-sizing: border-box;">GPU把合成结果呈现至屏幕</li>
</ol>
</li>
</ol>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">无论是在哪种工作模式下，从<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">代码到屏幕的过程</code>的过程中，其中的关键模式是页面渲染的分层机制，如浏览器会将页面的根节点置为默认的根节点层，在根节点层上进行层叠。每个层内的变动会触发当前层内节点进行重排relayout与重绘repaint，然后进行合并（重组recomposite）。这其中重绘repaint通常是耗时最长，最影响渲染性能的，所以如何尽可能的避免触发repaint是优化的关键。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">认识到浏览器的分层机制，我们如何加以利用来提升页面的渲染性能？<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">动静分离</code>，通过分层使页面的重绘repaint控制在有限区域，而不是在最糟糕的情况下页面中任何节点的变动会触发所有节点的重新计算。以移动一个矩形节点做为演示，主要代码如下：</p>
<pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; line-height: 1.42857143; word-break: break-all; word-wrap: break-word; color: rgb(51, 51, 51); background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">
<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; white-space: pre-wrap; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px;">div {
  -webkit-animation-duration: 5s;
  -webkit-animation-name: move;
  -webkit-animation-iteration-count: infinite;
  -webkit-animation-direction: alternate;
  width: 200px;
  height: 200px;
  margin: 100px;
  background-color: #808080;
  position: absolute;
}

@-webkit-keyframes move{
    from {
        left: 100px;
    }
    to {
        left: 200px;
    }
}
</code>
</pre>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">在Chrome开发者工具中我们开启“显示绘制矩形”与“显示组合层边框”来查看页面的重绘与重组行为：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://cloud.githubusercontent.com/assets/677114/2926386/c6022c3e-d75b-11e3-880d-04b9ca45742f.png" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/9c8120dfe06ae353a31c3dc6291d9257.png" height="386" width="806"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">如下图当我们使用<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">left</code>来移动节点时会持续的触发重绘，表现为红色边框：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://f.cloud.github.com/assets/677114/1755561/a8fb9c94-6666-11e3-8788-ac5b5ef4ef24.gif" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/b8ad4fd62c574b9aa0609ccf6643906b.gif" height="251" width="392"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">现代智能手机已普遍内置有GPU，浏览器会优先使用硬件加速模式，如何触发其分层呢？</p>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">触发分层常⽤用技巧</h4>
<ol style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">
<li style="box-sizing: border-box;">CSS 3D变形 <code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">transform: translate3d(0,0,0)</code>;</li>
<li style="box-sizing: border-box;">CSS perspective变形 <code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">transform: perspective(0)</code>;</li>
<li style="box-sizing: border-box;">
<p style="box-sizing: border-box;">CSS动画中含有透明或变形属性</p>
<pre style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 13px; padding: 9.5px; line-height: 1.42857143; word-break: break-all; word-wrap: break-word; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">
<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; white-space: pre-wrap; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px;">@-webkit-keyframes move{ 
    from {
        -webkit-transform: translateX(100px); }
    to {
        -webkit-transform: translateX(200px);
    }
}
</code>
</pre></li>
</ol>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">如下图我们在动画中通过<code style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; padding: 2px 4px; color: rgb(199, 37, 78); background-color: rgb(249, 242, 244); white-space: nowrap; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px;">-webkit-transform</code>来移动节点时，此时触发浏览器使该节点置为独立的层，因此在移动过程中浏览器只需进行重组，图中表现为橙色边框：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="https://f.cloud.github.com/assets/677114/1755562/aaef262e-6666-11e3-8e83-3e770f269af0.gif" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/2cadd4047de7e9430201eca824601d6e.gif" height="251" width="392"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">触发分层的原因还不止这些，通过Chrome Layers面板，我可以查看浏览器具体分层原因：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://img1.tbcdn.cn/L1/461/1/1a74440373106a10b2b2593050dd4d2327a0ec8e" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/fa5f370fcd3fbd45e082bd3d1f93cba5.png" height="858" width="1358"/></a></p>
<h4 style="box-sizing: border-box; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-weight: 500; line-height: 1.1; color: rgb(51, 51, 51); font-size: 18px; background-color: rgb(255, 255, 255);">分层不是银弹</h4>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">任何事物都具有两面性，分层技巧的使用同样如此。过多的层叠，会让占用更多的内存，这是可以理解的，典型的空间换时间的思想。如下截图中的演示（Safari开发者工具）：</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://img1.tbcdn.cn/L1/461/1/badbd30ec3cd50c667ccdd2815b6c8b3823e9771" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/7909ad18511bdbccbc04e1be971f8a4d.png" height="1104" width="1404"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://img3.tbcdn.cn/L1/461/1/f8616244ab9071f7ac0c964ae70f1600393d4674" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/d34be43682052918de3daedf6bea1e6d.png" height="1098" width="1358"/></a></p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);">虽然页面的重绘减少了近5倍，但同时内存上涨了10倍，虽然几十兆的内存对于现代手机并不是算是一个很大的问题，但在Webveiw场景里我们需要额外关注一些技术细节，如Webview UI线程是共享与Native视图线程的，一旦Webview挂了，整个Native应用也将异常退出。</p>
<p style="box-sizing: border-box; letter-spacing: 0.03rem; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; line-height: 27.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://img4.tbcdn.cn/L1/461/1/d21f24689694f635640aff5fdc766a9b5c8626ec" target="_blank" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/0e82986071434b969bfcc0fa1e250251.png" height="658" width="1364"/></a></p>
<div style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://www.atatech.org/users/72668" style="box-sizing: border-box; background-color: transparent; color: rgb(62, 137, 220); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><span style="-evernote-last-insertion-point:true;"/>阎王</a><span style="box-sizing: border-box; font-size: 12px; float: right !important;">12天前</span></div>
<div style="box-sizing: border-box; word-wrap: break-word; overflow: hidden; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px; background-color: rgb(255, 255, 255);">
<p style="box-sizing: border-box;">感谢元彦童鞋的分享，最近几天正好在看DOM的渲染过程，表达的很清晰。</p>
<p style="box-sizing: border-box;">当我们用JS去修改一些CSS属性的时候，浏览器并不会重复以上的工作，一般的重绘就是修改对应的Layer层，生成bigmap，然后上传到GPU上，在设定的复合属性下进行层和层之间的复合。</p>
<p style="box-sizing: border-box;">对于重排，浏览器也做了一些优化，他会向上冒泡找到最终影响的层级，并将该层级下所有的元素标记为垃圾元素，进行清理和重新处理。</p>
<p style="box-sizing: border-box;">我在学习的时候又一个疑问，栅格化的作用是什么，记得页面渲染的时候是按照栅格化的方式进行渲染，至于如何处理的，还没有看到文章介绍过。</p>
</div>
<div style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px; background-color: rgb(255, 255, 255);"/>
<div style="box-sizing: border-box; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px; background-color: rgb(255, 255, 255);"><a href="http://www.atatech.org/comments/17408/voteup" title="赞" rel="nofollow" style="box-sizing: border-box; background-image: none; background-color: transparent; color: rgb(164, 164, 164); text-decoration: none; text-align: center; vertical-align: middle; cursor: pointer; border: 0px solid transparent; white-space: nowrap; padding: 5px 10px; font-size: 12px; line-height: 1.5; border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; -webkit-user-select: none; -webkit-box-shadow: none; box-shadow: none;"> 0</a>  <span style="box-sizing: border-box;">1</span></div>
<div style="box-sizing: border-box; color: rgb(78, 78, 78); background-color: rgb(255, 255, 255); border: 1px solid rgb(216, 215, 215); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px;">
<div style="box-sizing: border-box; padding-left: 0px; list-style: none;">
<div style="box-sizing: border-box; overflow: hidden; zoom: 1; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(238, 238, 238); padding-left: 20px; padding-right: 20px; background-color: transparent; transition: background-color 1.5s 100ms; -webkit-transition: background-color 1.5s 100ms;">
<div style="box-sizing: border-box; float: left !important;"><a href="http://www.atatech.org/users/38747" style="box-sizing: border-box; background-color: transparent; color: rgb(66, 139, 202); text-decoration: none; background-position: initial initial; background-repeat: initial initial;"><img src="%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%A7%BB%E5%8A%A8web%E5%BA%94%E7%94%A8.resources/785950ec655b85323e6582de90343ecf.jpeg" height="60" width="60"/></a></div>
<div style="box-sizing: border-box; overflow: hidden; zoom: 1;">
<div style="box-sizing: border-box;"><a href="http://www.atatech.org/users/38747" style="box-sizing: border-box; background-color: transparent; color: rgb(62, 137, 220); text-decoration: none; background-position: initial initial; background-repeat: initial initial;">元彦</a>11天前</div>
</div>
</div>
</div>
</div>
<div><a href="http://www.atatech.org/users/72668" style="font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px; box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none;">@阎王</a><span style="color: rgb(78, 78, 78); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px;"> 关于图层位图栅格化为纹理（texture），即在我们开启”Show composited layer borders“时页面中出现的格子线条。为什么浏览器要对图层进行栅格化？1. GPU处理过大图层效率低，与hardware特性相关 2.切分后可并行化处理，可参考chrome团队写的多线程栅格化这篇文章：</span><a href="http://www.chromium.org/developers/design-documents/impl-side-painting" style="font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px; box-sizing: border-box; color: rgb(66, 139, 202); text-decoration: none;">http://www.chromium.org/developers/design-documents/impl-side-painting</a><span style="color: rgb(78, 78, 78); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 14px; line-height: 25.200000762939453px;">3. Chrome默认是纹理大小是256*256，如512*512图层会被切分为4片</span><span style="box-sizing: border-box; font-size: 32px;"><br/></span></div>
<div><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;"><br/></span></div>
<div><span style="background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; letter-spacing: 0.03rem; line-height: 27.200000762939453px;"><br/></span></div>
</body></html>